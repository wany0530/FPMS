<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
	
<mapper namespace="zenkit.web.dao.A01_AllDashDao">

	<!-- 종합 대시보드 프로젝트 리스트 (전체프로젝트)-->
	<!-- public ArrayList<AllDashBoard> allProjList(); -->
	<select id="allProjList" resultType="allDash">
	<![CDATA[
	SELECT zp.P_NAME, zp.P_NO , zd.D_NAME, 
		zp.P_STARTD, zp.P_ENDD, count(zo.O_NO) AS poCnt,
		trunc(zp.P_ENDD)-trunc(sysdate) dDay,
		(CASE WHEN (sysdate < zp.P_STARTD) THEN 0
	  WHEN (sysdate > zp.P_ENDD) THEN 100
	  ELSE ROUND(MOD((trunc(sysdate-zp.P_STARTD))/(trunc(zp.P_ENDD-zp.P_STARTD)),1)*100,0) END) percent ,
		zu.U_NAME AS pmName,
		(CASE WHEN (sysdate < zp.P_STARTD) THEN '시작전'
	 	 WHEN (sysdate > zp.P_ENDD) THEN '완료'
		 ELSE '진행' END) progress 
	FROM Z_PROJECT zp, Z_USER zu , Z_OUTPUTS zo, Z_RESOURCE zr, Z_JOB zj, Z_DEPARTMENT zd, Z_POSITION zp2 
	WHERE zu.U_NO = zr.U_NO 
	AND zp.P_NO = zr.P_NO 
	AND zr.U_NO = zj.U_NO 
	AND zr.P_NO = zj.P_NO 
	AND zj.J_NO = zo.J_NO 
	AND zd.D_NO = zp.D_NO
	AND zp2.POS_NO = 3
	AND zp2.POS_NO = zu.POS_NO 
	GROUP BY zp.P_NAME, zp.P_NO , zd.D_NAME, 
			zp.P_STARTD, zp.P_ENDD, zu.U_NAME
	ORDER BY zp.p_no
	]]>
	</select>
	
	<!-- 종합 대시보드 프로젝트 리스트 (부서별)-->
	<!-- public ArrayList<AllDashBoard> deptProjList(int d_no); -->
	<select id="deptProjList" resultType="allDash" parameterType="int">
	<![CDATA[
	SELECT zp.P_NAME, zp.P_NO , zd.D_NAME, 
		zp.P_STARTD, zp.P_ENDD, count(zo.O_NO) AS poCnt,
		trunc(zp.P_ENDD)-trunc(sysdate) dDay,
		(CASE WHEN (sysdate < zp.P_STARTD) THEN 0
	  WHEN (sysdate > zp.P_ENDD) THEN 100
	  ELSE ROUND(MOD((trunc(sysdate-zp.P_STARTD))/(trunc(zp.P_ENDD-zp.P_STARTD)),1)*100,0) END) percent ,
		zu.U_NAME AS pmName,
		(CASE WHEN (sysdate < zp.P_STARTD) THEN '시작전'
	 	 WHEN (sysdate > zp.P_ENDD) THEN '완료'
		 ELSE '진행' END) progress 
	FROM Z_PROJECT zp, Z_USER zu , Z_OUTPUTS zo, Z_RESOURCE zr, Z_JOB zj, Z_DEPARTMENT zd, Z_POSITION zp2 
	WHERE zu.U_NO = zr.U_NO 
	AND zp.P_NO = zr.P_NO 
	AND zr.U_NO = zj.U_NO 
	AND zr.P_NO = zj.P_NO 
	AND zj.J_NO = zo.J_NO 
	AND zd.D_NO = zp.D_NO
	AND zp2.POS_NO = 3
	AND zp2.POS_NO = zu.POS_NO 
	AND zd.D_NO = #{D_NO}
	GROUP BY zp.P_NAME, zp.P_NO , zd.D_NAME, 
			zp.P_STARTD, zp.P_ENDD, zu.U_NAME
	ORDER BY zp.p_no
	]]>
	</select>
	
	
	<!-- 종합 대시보드 주요 프로젝트 현황 셀렉트박스 -부서명 -->
	<!-- public ArrayList<AllDashBoard> getDname(); -->
	<select id="getDname" resultType="allDash">
	SELECT D_NAME,D_NO
	FROM Z_DEPARTMENT	
	</select>
		
	<!-- 종합 대시보드 주요 프로젝트 현황 셀렉트박스 -진행상태 -->
	<!-- public ArrayList<AllDashBoard> getProgress(); -->
	<select id="getProgress" resultType="allDash">
	<![CDATA[
	SELECT DISTINCT (CASE WHEN (sysdate < zp.P_STARTD) THEN '시작전'
	 	 WHEN (sysdate > zp.P_ENDD) THEN '완료'
		 ELSE '진행' END) progress 
	FROM z_project zp
	]]>
	</select>
	
	<!-- 종합 대시보드 주요 프로젝트 현황 셀렉트박스 -연도 -->
	<!-- public ArrayList<AllDashBoard> getYear1(); -->
	<select id="getYear1" resultType="allDash">
	SELECT DISTINCT TO_CHAR(P_STARTD,'YYYY') pYear1
	FROM Z_PROJECT 
	ORDER BY pYear1 DESC	
	</select>
	
	<!-- 종합 대시보드 프로젝트 수행지표 리스트 (전체부서) -->
	<!-- public ArrayList<AllDashBoard> getAllCnt(); -->
	<select id="getAllCnt" resultType="allDash">
	<![CDATA[
	SELECT a.D_NAME, COUNT(*) allCnt
	, SUM(CASE WHEN sysdate < a.P_STARTD THEN 1 ELSE 0 END) AS before_Cnt
	, SUM(CASE WHEN sysdate >= a.P_STARTD AND SYSDATE <= a.P_ENDD AND a.J_COMPLETER NOT IN (0,1) THEN 1 ELSE 0 END) AS ongoing_Cnt
	, SUM(CASE WHEN a.J_COMPLETER = 1 THEN 1 ELSE 0 END) AS complete_Cnt
	, SUM(CASE WHEN a.J_COMPLETER != 1 AND SYSDATE > a.P_ENDD THEN 1 ELSE 0 END) AS late_Cnt
	, a.D_NO
	FROM (SELECT zd.D_NAME , zp.P_NAME, zp.P_STARTD ,zp.P_ENDD ,zj.J_COMPLETER,zd.D_NO 
		FROM Z_PROJECT zp , Z_DEPARTMENT zd , Z_JOB zj
		, (
			SELECT
				P_NO 
			FROM Z_RESOURCE a
			GROUP BY p_no
		) zr
		WHERE zd.D_NO = zp.D_NO 
		AND zr.P_NO = zp.P_NO 
		AND zp.P_NO = zj.P_NO 
		AND zj.J_REFNO =0) a
	GROUP BY a.D_NAME, a.D_NO
	]]>
	</select>
	
	<!-- 종합 대시보드 프로젝트 수행지표 리스트 (부서 내 프로젝트별) -->
	<!-- public ArrayList<AllDashBoard> getAllProjCnt(int d_no); -->
	<select id="getAllProjCnt" resultType="allDash" parameterType="int">
	<![CDATA[
	SELECT a.P_NAME, COUNT(*) allCnt
	, SUM(CASE WHEN sysdate < a.P_STARTD THEN 1 ELSE 0 END) AS before_Cnt
	, SUM(CASE WHEN sysdate >= a.P_STARTD AND SYSDATE <= a.P_ENDD AND a.J_COMPLETER NOT IN (0,1) THEN 1 ELSE 0 END) AS ongoing_Cnt
	, SUM(CASE WHEN a.J_COMPLETER = 1 THEN 1 ELSE 0 END) AS complete_Cnt
	, SUM(CASE WHEN a.J_COMPLETER != 1 AND SYSDATE > a.P_ENDD THEN 1 ELSE 0 END) AS late_Cnt
	FROM (SELECT zd.D_NAME , zp.P_NAME, zp.P_STARTD ,zp.P_ENDD ,zj.J_COMPLETER  
		FROM Z_PROJECT zp , Z_DEPARTMENT zd , Z_JOB zj
		, (
			SELECT
				P_NO 
			FROM Z_RESOURCE a
			GROUP BY p_no
		) zr
		WHERE zd.D_NO = zp.D_NO 
		AND zr.P_NO = zp.P_NO 
		AND zp.P_NO = zj.P_NO 
		AND zj.J_REFNO =0
		AND zd.D_NO = #{D_NO}) a
	GROUP BY a.P_NAME
	]]>
	</select>
	
	
</mapper>