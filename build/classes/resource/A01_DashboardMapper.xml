<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="zenkit.web.dao.A01_DashboardDao">

	<!-- 개인 대시보드 작업물 개수 -->
	<!-- public int jobCnt(int u_no) -->
	<select id="jobCnt" resultType="int" parameterType="int">
		SELECT count(*)
		FROM Z_USER zu , Z_JOB zj, Z_RESOURCE zr
		WHERE zu.U_NO = zr.U_NO
		AND zr.P_NO = zj.P_NO
		AND zr.U_NO = zj.U_NO
		AND zr.U_NO = #{U_NO}
		<!-- AND zr.U_NO = #{U_NO} -->
	</select>

	<!-- 개인 대시보드 프로젝트 개수 -->
	<!-- public int projectCnt(int u_no) -->
	<select id="projectCnt" resultType="int" parameterType="int">
		SELECT
		count(*)
		FROM Z_USER zu, Z_RESOURCE zr, Z_PROJECT zp
		WHERE zu.U_NO = zr.U_NO
		AND zr.P_NO = zp.P_NO
		AND zu.U_NO = #{U_NO}
	</select>


	<!-- 개인 대시보드 산출물 개수 -->
	<!-- public int outputCnt(int u_no) -->
	<select id="outputCnt" resultType="int" parameterType="int">
		SELECT
		count(*)
		FROM Z_USER zu, Z_RESOURCE zr, Z_JOB zj, Z_PROJECT zp,
		Z_OUTPUTS zo
		WHERE zu.U_NO = zr.U_NO
		AND zr.U_NO = zj.U_NO
		AND zr.P_NO = zp.P_NO
		AND zr.P_NO = zj.P_NO
		AND zj.J_NO = zo.J_NO
		AND zu.U_NO = #{U_NO}
	</select>


	<!-- 개인 대시보드 프로젝트 별 기간 -->
	<!-- public ArrayList<DashBoard> projectDate(int u_no); -->
	<resultMap type="dashboard" id="projDateList"></resultMap>
	<select id="projectDate" resultMap="projDateList"
		parameterType="int">
		SELECT zp.P_NAME ,
		trunc(zp.P_ENDD)-trunc(sysdate) dDay,
		ROUND(MOD((trunc(sysdate-P_STARTD))/(trunc(zp.P_ENDD-zp.P_STARTD)),1)*100,0)
		percent
		FROM Z_PROJECT zp, Z_USER zu , Z_RESOURCE zr
		WHERE sysdate
		BETWEEN zp.P_STARTD AND zp.P_ENDD
		AND zu.U_NO = zr.U_NO
		AND zr.P_NO = zp.P_NO
		AND zu.U_NO = #{U_NO}
	</select>


	<!-- 개인 대시보드 프로젝트 테이블 -->
	<!-- public ArrayList<DashBoard> projectList(int u_no); -->
	<resultMap type="dashboard" id="projList"></resultMap>
	<select id="projectList" resultMap="projList"
		parameterType="int">
	<![CDATA[
		SELECT DISTINCT P_NAME, zp.P_NO , p_pm, zd.D_NAME, 
			P_STARTD, P_ENDD, count(zo.O_NO) AS poCnt, 
			trunc(zp.P_ENDD)-trunc(sysdate) dDay,
			ROUND(MOD((trunc(sysdate-P_STARTD))/(trunc(zp.P_ENDD-zp.P_STARTD)),1)*100,0) percent,
			(CASE WHEN (sysdate < zp.P_STARTD) THEN '시작전'
		 	 WHEN (sysdate > zp.P_ENDD) THEN '완료'
			 ELSE '진행' END) progress 	
		FROM Z_PROJECT zp, Z_USER zu, Z_OUTPUTS zo, Z_RESOURCE zr, Z_JOB zj, Z_DEPARTMENT zd
		WHERE zu.U_NO = zr.U_NO
			AND zp.P_NO = zr.P_NO
			AND zr.U_NO = zj.U_NO(+)
			AND zj.J_NO = zo.J_NO(+)
			AND zd.D_NO = zp.D_NO
			AND zr.P_NO = zj.P_NO(+)

		AND zr.U_NO = #{U_NO}
		GROUP BY P_NAME, zp.P_NO , p_pm, zd.D_NAME, 
				P_STARTD, P_ENDD
		ORDER BY zp.p_no
	]]>
	</select>

</mapper>